(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/HM-chat"],{"2c15":function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var s={name:"UniDrawer",props:{visible:{type:Boolean,default:!1},mode:{type:String,default:""},mask:{type:Boolean,default:!0}},data:function(){return{visibleSync:!1,showDrawer:!1,rightMode:!1,closeTimer:null,watchTimer:null}},watch:{visible:function(t){var e=this;clearTimeout(this.watchTimer),setTimeout(function(){e.showDrawer=t},100),this.visibleSync&&clearTimeout(this.closeTimer),t?this.visibleSync=t:this.watchTimer=setTimeout(function(){e.visibleSync=t},300)}},created:function(){var t=this;this.visibleSync=this.visible,setTimeout(function(){t.showDrawer=t.visible},100),this.rightMode="right"===this.mode},methods:{close:function(){var t=this;this.showDrawer=!1,this.closeTimer=setTimeout(function(){t.visibleSync=!1,t.$emit("close")},200)},moveHandle:function(){}}};e.default=s},"3e35":function(t,e,i){"use strict";i.r(e);var s=i("a1f2"),n=i("f02b");for(var o in n)"default"!==o&&function(t){i.d(e,t,function(){return n[t]})}(o);i("4e75");var a=i("2877"),c=Object(a["a"])(n["default"],s["a"],s["b"],!1,null,null,null);e["default"]=c.exports},"4e75":function(t,e,i){"use strict";var s=i("9e06"),n=i.n(s);n.a},"6c57":function(t,e,i){"use strict";(function(t,s){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;c(i("bd16"));var n=c(i("90d0")),o=c(i("9db6")),a=(c(i("e14f")),i("2f62"),c(i("814b")));function c(t){return t&&t.__esModule?t:{default:t}}var r=null,u={data:function(){return{account:"",token:"",textMsg:"",isHistoryLoading:!1,scrollAnimation:!1,scrollTop:0,scrollToView:"",msgList:[],msgImgList:[],myuid:0,SocketOpend:!1,RECORDER:t.getRecorderManager(),isVoice:!1,voiceTis:"按住 说话",recordTis:"手指上滑 取消发送",recording:!1,willStop:!1,initPoint:{identifier:0,Y:0},recordTimer:null,recordLength:0,AUDIO:t.createInnerAudioContext(),playMsgid:null,VoiceTimer:null,popupLayerClass:"",hideMore:!0,hideEmoji:!0,emojiList:null,onlineEmoji:null,windowsState:"",redenvelopeData:{rid:null,from:null,face:null,blessing:null,money:null}}},onLoad:function(t){var e=this;this.getMsgList(),this.emojiList=o.default.emojiList,this.onlineEmoji=o.default.onlineEmoji;this.AUDIO.onEnded(function(t){e.playMsgid=null}),this.RECORDER.onStart(function(t){e.recordBegin(t)}),this.RECORDER.onStop(function(t){e.recordEnd(t)})},onShow:function(){this.scrollTop=9999999;var e=getApp();this.BackgroundImage=e.globalData.BackgroundImageList;var i=this,o=e.globalData.token||"test";this.token=o;var c=e.globalData.account;this.account=c,this.myuid=c,null==r&&(r=t.connectSocket({url:a.default.socapi,header:a.default.header,protocols:[c],success:function(t){i.SocketOpend=!0}}),n.default.KeepTimer(r,c,o)),r.onMessage(function(n){var o=JSON.parse(n.data);"illegal"==o.type&&(clearInterval(e.globalData.SocketTimer),r.close(),r=null,plus.nativeUI.toast("数据非法"),t.reLaunch({url:"../login/login",animationType:"pop-out",animationDuration:200})),"loginrepeat"==o.type&&(clearInterval(e.globalData.SocketTimer),r.close(),r=null,t.showModal({title:"警告",content:"你已在异地登录，建议修改密码",success:function(t){}}),t.reLaunch({url:"../login/login",animationType:"pop-out",animationDuration:200})),console.log(s("接受到了消息--------------------"," at pages\\chat\\HM-chat.vue:301")),console.log(s(o," at pages\\chat\\HM-chat.vue:302")),i.screenMsg(o)})},methods:{screenMsg:function(e){if("system"==e.type)switch(e.msg.type){case"text":this.addSystemTextMsg(e);break;case"redEnvelope":this.addSystemRedEnvelopeMsg(e);break}else if("user"==e.type){switch(e.msg.type){case"text":this.addTextMsg(e);break;case"voice":this.addVoiceMsg(e);break;case"img":this.addImgMsg(e);break;case"redEnvelope":this.addRedEnvelopeMsg(e);break}e.msg.userinfo.uid!=this.myuid&&(console.log(s("振动"," at pages\\chat\\HM-chat.vue:339")),t.vibrateLong())}this.$nextTick(function(){this.scrollToView="msg"+e.msg.id})},loadHistory:function(t){var e=this;if(!this.isHistoryLoading){this.isHistoryLoading=!0,this.scrollAnimation=!1;var i=this.msgList[0].msg.id;setTimeout(function(){for(var t=[{type:"user",msg:{id:1,type:"text",time:"12:56",userinfo:{uid:0,username:"大黑哥",face:"/static/img/face.jpg"},content:{text:"为什么温度会相差那么大？"}}},{type:"user",msg:{id:2,type:"text",time:"12:57",userinfo:{uid:1,username:"售后客服008",face:"/static/img/im/face/face_2.jpg"},content:{text:"这个是有偏差的，两个温度相差十几二十度是很正常的，如果相差五十度，那即是质量问题了。"}}},{type:"user",msg:{id:3,type:"voice",time:"12:59",userinfo:{uid:1,username:"售后客服008",face:"/static/img/im/face/face_2.jpg"},content:{url:"/static/voice/1.mp3",length:"00:06"}}},{type:"user",msg:{id:4,type:"voice",time:"13:05",userinfo:{uid:0,username:"大黑哥",face:"/static/img/face.jpg"},content:{url:"/static/voice/2.mp3",length:"00:06"}}}],s=0;s<t.length;s++)"user"==t[s].type&&"img"==t[s].msg.type&&(t[s].msg.content=e.setPicSize(t[s].msg.content),e.msgImgList.unshift(t[s].msg.content.url)),t[s].msg.id=Math.floor(1e3*Math.random()+1),e.msgList.unshift(t[s]);e.$nextTick(function(){this.scrollToView="msg"+i,this.$nextTick(function(){this.scrollAnimation=!0})}),e.isHistoryLoading=!1},1e3)}},getMsgList:function(){for(var t=[{type:"system",msg:{id:0,type:"text",content:{text:"欢迎您进入聊天室"}}}],e=0;e<t.length;e++)"user"==t[e].type&&"img"==t[e].msg.type&&(t[e].msg.content=this.setPicSize(t[e].msg.content),this.msgImgList.push(t[e].msg.content.url));this.msgList=t,this.$nextTick(function(){this.scrollTop=9999,this.$nextTick(function(){this.scrollAnimation=!0})})},setPicSize:function(e){var i=t.upx2px(350),s=t.upx2px(350);if(e.w>i||e.h>s){var n=e.w/e.h;e.w=n>1?i:s*n,e.h=n>1?i/n:s}return e},showMore:function(){this.isVoice=!1,this.hideEmoji=!0,this.hideMore?(this.hideMore=!1,this.openDrawer()):this.hideDrawer()},openDrawer:function(){this.popupLayerClass="showLayer"},hideDrawer:function(){var t=this;this.popupLayerClass="",setTimeout(function(){t.hideMore=!0,t.hideEmoji=!0},150)},chooseImage:function(){this.getImage("album")},camera:function(){this.getImage("camera")},handRedEnvelopes:function(){t.navigateTo({url:"HM-hand/HM-hand"}),this.hideDrawer()},getImage:function(e){var i=this;this.hideDrawer();var s=this;t.chooseImage({sourceType:[e],sizeType:["original","compressed"],success:function(e){for(var n=function(n){t.getImageInfo({src:e.tempFilePaths[n],success:function(t){var o={url:e.tempFilePaths[n],w:t.width,h:t.height},a=plus.uploader.createUpload("http://1904007754.tpddns.cn:9501/new/CHAT/chatimg.php",{method:"POST",blocksize:0,priority:100},function(t,e){o.url2=t.responseText,200==e?(plus.nativeUI.toast("图片发送成功"),s.sendMsg(o,"img")):plus.nativeUI.toast("图片发送失败")});a.addFile(e.tempFilePaths[n],{key:"testdoc"+n}),a.addData("account",i.account),a.addData("token",i.token),a.start()}})},o=0;o<e.tempFilePaths.length;o++)n(o)}})},chooseEmoji:function(){this.hideMore=!0,this.hideEmoji?(this.hideEmoji=!1,this.openDrawer()):this.hideDrawer()},addEmoji:function(t){this.textMsg+=t.alt},textareaFocus:function(){"showLayer"==this.popupLayerClass&&0==this.hideMore&&this.hideDrawer()},sendText:function(){if(this.hideDrawer(),this.textMsg){var t=this.replaceEmoji(this.textMsg),e={text:t,text2:this.textMsg};this.sendMsg(e,"text"),this.textMsg=""}},replaceEmoji:function(t){var e=this,i=t.replace(/\[([^(\]|\[)]*)\]/g,function(t,i){console.log(s("item: "+t," at pages\\chat\\HM-chat.vue:570"));for(var n=0;n<e.emojiList.length;n++)for(var o=e.emojiList[n],a=0;a<o.length;a++){var c=o[a];if(c.alt==t){var r="https://s2.ax1x.com/2019/04/12/",u='<img src="'+r+e.onlineEmoji[c.url]+'">';return console.log(s("imgstr: "+u," at pages\\chat\\HM-chat.vue:580")),u}}});return'<div style="display: flex;align-items: center;word-wrap:break-word;">'+i+"</div>"},sendMsg:function(t,e){var i=new Date,o=this.msgList[this.msgList.length-1].msg.id;o++;var a={type:"user",msg:{id:o,time:i.getHours()+":"+i.getMinutes(),type:e,userinfo:{uid:this.account,username:"我",face:"/static/img/face.jpg"},content:t}},c={account:this.account,type:"toall",token:this.token,msgtype:e,msg:t.url2||t.text2,imgh:t.h||"",imgw:t.w||"",voicelen:t.length||""};console.log(s(c," at pages\\chat\\HM-chat.vue:616")),n.default.SendMsg(r,c),this.screenMsg(a)},addTextMsg:function(t){this.msgList.push(t)},addVoiceMsg:function(t){this.msgList.push(t)},addImgMsg:function(t){t.msg.content=this.setPicSize(t.msg.content),this.msgImgList.push(t.msg.content.url),this.msgList.push(t)},addRedEnvelopeMsg:function(t){this.msgList.push(t)},addSystemTextMsg:function(t){this.msgList.push(t)},addSystemRedEnvelopeMsg:function(t){this.msgList.push(t)},openRedEnvelope:function(e,i){var n=this,o=e.content.rid;t.showLoading({title:"加载中..."}),console.log(s("index: "+i," at pages\\chat\\HM-chat.vue:652")),setTimeout(function(){0==o?n.redenvelopeData={rid:0,from:"大黑哥",face:"/static/img/im/face/face.jpg",blessing:"恭喜发财，大吉大利",money:"已领完"}:(n.redenvelopeData={rid:1,from:"售后客服008",face:"/static/img/im/face/face_2.jpg",blessing:"恭喜发财",money:"0.01"},e.content.isReceived||(n.sendSystemMsg({text:"你领取了"+(e.userinfo.uid==n.myuid?"自己":e.userinfo.username)+"的红包"},"redEnvelope"),console.log(s("this.msgList[index]: "+JSON.stringify(n.msgList[i])," at pages\\chat\\HM-chat.vue:675")),n.msgList[i].msg.content.isReceived=!0)),t.hideLoading(),n.windowsState="show"},200)},closeRedEnvelope:function(){var t=this;this.windowsState="hide",setTimeout(function(){t.windowsState=""},200)},sendSystemMsg:function(t,e){var i=this.msgList[this.msgList.length-1].msg.id;i++;var s={type:"system",msg:{id:i,type:e,content:t}};this.screenMsg(s)},toDetails:function(e){t.navigateTo({url:"HM-details/HM-details?rid="+e})},showPic:function(e){t.previewImage({indicator:"none",current:e.content.url,urls:this.msgImgList})},playVoice:function(t){this.playMsgid=t.id,this.AUDIO.src=t.content.url,this.$nextTick(function(){this.AUDIO.play()})},voiceBegin:function(t){t.touches.length>1||(this.initPoint.Y=t.touches[0].clientY,this.initPoint.identifier=t.touches[0].identifier,this.RECORDER.start({format:"mp3"}))},recordBegin:function(t){var e=this;this.recording=!0,this.voiceTis="松开 结束",this.recordLength=0,this.recordTimer=setInterval(function(){e.recordLength++},1e3)},voiceCancel:function(){this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.willStop=!0,this.RECORDER.stop()},voiceIng:function(e){if(this.recording){var i=e.touches[0];this.initPoint.Y-i.clientY>=t.upx2px(100)?(this.willStop=!0,this.recordTis="松开手指 取消发送"):(this.willStop=!1,this.recordTis="手指上滑 取消发送")}},voiceEnd:function(t){this.recording&&(this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.RECORDER.stop())},recordEnd:function(t){clearInterval(this.recordTimer);var e=this;if(this.willStop)console.log(s("取消发送录音"," at pages\\chat\\HM-chat.vue:811"));else{var i={length:0,url:t.tempFilePath},n=parseInt(this.recordLength/60),o=this.recordLength%60;if(n=n<10?"0"+n:n,o=o<10?"0"+o:o,i.length=n+":"+o,this.recordLength<1)return this.willStop=!1,void plus.nativeUI.toast("录音时间太短");var c=plus.uploader.createUpload(a.default.chatvoice,{method:"POST",blocksize:0,priority:100},function(t,s){i.url2="http://1904007754.tpddns.cn:9501/new/CHAT/"+t.responseText,200==s?(e.sendMsg(i,"voice"),plus.nativeUI.toast("语音发送成功")):plus.nativeUI.toast("语音发送失败")});c.addFile(t.tempFilePath,{key:"testdoc"}),c.addData("token",this.token),c.addData("account",this.account),c.start()}this.willStop=!1},switchVoice:function(){this.hideDrawer(),this.isVoice=!this.isVoice},discard:function(){}}};e.default=u}).call(this,i("6e42")["default"],i("0de9")["default"])},7057:function(t,e,i){"use strict";i.r(e);var s=i("2c15"),n=i.n(s);for(var o in s)"default"!==o&&function(t){i.d(e,t,function(){return s[t]})}(o);e["default"]=n.a},"944d":function(t,e,i){},"96ae":function(t,e,i){"use strict";var s=i("944d"),n=i.n(s);n.a},"9e06":function(t,e,i){},a1f2:function(t,e,i){"use strict";var s=function(){var t=this,e=t.$createElement;t._self._c},n=[];i.d(e,"a",function(){return s}),i.d(e,"b",function(){return n})},c910:function(t,e,i){"use strict";var s=function(){var t=this,e=t.$createElement;t._self._c},n=[];i.d(e,"a",function(){return s}),i.d(e,"b",function(){return n})},e14f:function(t,e,i){"use strict";i.r(e);var s=i("c910"),n=i("7057");for(var o in n)"default"!==o&&function(t){i.d(e,t,function(){return n[t]})}(o);i("96ae");var a=i("2877"),c=Object(a["a"])(n["default"],s["a"],s["b"],!1,null,null,null);e["default"]=c.exports},e794:function(t,e,i){"use strict";(function(t){i("4fad"),i("921b");s(i("66fd"));var e=s(i("3e35"));function s(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,i("6e42")["createPage"])},f02b:function(t,e,i){"use strict";i.r(e);var s=i("6c57"),n=i.n(s);for(var o in s)"default"!==o&&function(t){i.d(e,t,function(){return s[t]})}(o);e["default"]=n.a}},[["e794","common/runtime","common/vendor"]]]);